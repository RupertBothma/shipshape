{
  "__inputs": [],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "9.0.0" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "1.0.0" }
  ],
  "id": null,
  "uid": "shipshape-controller-overview",
  "title": "Shipshape Controller Overview",
  "tags": ["shipshape", "controller"],
  "timezone": "utc",
  "schemaVersion": 36,
  "version": 3,
  "refresh": "30s",
  "time": { "from": "now-1h", "to": "now" },
  "panels": [
    {
      "title": "Restart Rate by Environment",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
      "targets": [
        {
          "expr": "sum(rate(configmap_reload_restarts_total[5m])) by (env)",
          "legendFormat": "{{ env }}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "ops" } }
    },
    {
      "title": "Restart Error Rate by Environment",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
      "targets": [
        {
          "expr": "sum(rate(configmap_reload_errors_total[5m])) by (env)",
          "legendFormat": "{{ env }}"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "ops" } }
    },
    {
      "title": "Debounced Events by Environment",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
      "targets": [
        {
          "expr": "sum(rate(configmap_reload_debounced_total[5m])) by (env)",
          "legendFormat": "{{ env }}"
        }
      ]
    },
    {
      "title": "Watch Stream Health",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
      "targets": [
        {
          "expr": "rate(configmap_reload_watch_errors_total[5m])",
          "legendFormat": "watch errors/s"
        },
        {
          "expr": "rate(configmap_reload_watch_reconnects_total[5m])",
          "legendFormat": "reconnects/s"
        }
      ]
    },
    {
      "title": "Leadership Transitions (5m increase)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 },
      "targets": [
        {
          "expr": "sum(increase(configmap_reload_leader_transitions_total[5m])) by (transition)",
          "legendFormat": "{{ transition }}"
        }
      ]
    },
    {
      "title": "Leadership Acquisition Latency p95",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 16 },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(configmap_reload_leader_acquire_latency_seconds_bucket[5m])) by (le))",
          "legendFormat": "p95"
        }
      ],
      "fieldConfig": { "defaults": { "unit": "s" } }
    },
    {
      "title": "Pending Restart Queue Depth",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 24 },
      "targets": [
        {
          "expr": "configmap_reload_pending_restarts",
          "legendFormat": "pending"
        }
      ]
    },
    {
      "title": "Dropped Restarts (shutdown)",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 24 },
      "targets": [
        {
          "expr": "configmap_reload_dropped_restarts_total",
          "legendFormat": "dropped"
        }
      ]
    },
    {
      "title": "Current Leader State",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 24 },
      "targets": [
        {
          "expr": "max(configmap_reload_leader_state)",
          "legendFormat": "leader"
        }
      ]
    },
    {
      "title": "Leader State Over Time",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 28 },
      "targets": [
        {
          "expr": "max(configmap_reload_leader_state)",
          "legendFormat": "leader"
        }
      ]
    },
    {
      "title": "Pending Restart Queue Trend",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 28 },
      "targets": [
        {
          "expr": "max(configmap_reload_pending_restarts)",
          "legendFormat": "pending"
        },
        {
          "expr": "max_over_time(configmap_reload_pending_restarts[15m])",
          "legendFormat": "pending (15m max)"
        }
      ]
    }
  ]
}
